---
title: "Hydology Model: Watershed Snowpack Melt, Storage, and Streamflow Temperature "
author: "Bridget Gibbons, Claire Madden, Lydia Bleifuss"
date: "6/10/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      error = FALSE)
```

Requirements:

-Provice some rationale for why this is an important question to answer/management area

- Conceptual model 

- Perform sensitivity analysis for at least two parameters
- At least one sub-model should include a dynmaic ODE model
- Model would involve 3 submodels
-Visualize results in 2 different ways (graphs) 
- Write up results (explain how the model answers your original question/addresses your management area, explain importance of uncertainty in the results and any implications of the results for env. management) 


- SUBMIT! 
- model code (include .Rmd and tack on BRIEF write up at the end)

#####1] Introductory Summary


Some writing here, one sentence. 

![**Conceptual Model (obviously we will put a final one in later**](Stream_Snow_Conceptual_Model.jpg)


**1.** Read in packages. 
```{r}
library(tidyverse)
library(janitor)
library(here)
library(readxl)
library(ggplot2)
library(paletteer)
library(zoo)

#USGS
library(dataRetrieval)

#SNOTEL
library(RNRCS)
```

**2.** Pull in snowpack melt data.
```{r}
#MELT SUBMODEL DATA PULL 
#SWE & AMBIENT AIR: Snotel (843) 
snotel_vallecito_temp_swe <- grabNRCS.data(network = "SNTL", 
                            site_id = 843,
                            timescale = "daily", 
                            DayBgn = "1990-10-01", #what start date do we want? 
                            DayEnd = "2020-09-30") %>% 
  select(Date, Snow.Water.Equivalent..in..Start.of.Day.Values, Air.Temperature.Average..degF., Air.Temperature.Maximum..degF.) %>% 
  rename(Snow_Water_Equivalent_in = Snow.Water.Equivalent..in..Start.of.Day.Values, Daily_Ave_Temp_F = Air.Temperature.Average..degF., Daily_Max_Temp_F = Air.Temperature.Maximum..degF.)%>% 
  mutate(Date = as.Date.character(Date)) %>% 
  mutate(Daily_Ave_Temp_C = (Daily_Ave_Temp_F*0.5556)) %>% 
  mutate(Daily_Max_Temp_C = (Daily_Max_Temp_F*0.5556))


snotel_clean <- snotel_vallecito_temp_swe %>% 
  mutate(year = lubridate::year(Date)) %>% 
  mutate(year = as.numeric(year)) %>% 
  mutate(month = lubridate::month(Date)) %>% 
  mutate(month = as.numeric(month)) %>% 
  mutate(day = lubridate::day(Date)) %>% 
mutate(day = as.numeric(day))


snotel_final_swe <- snotel_clean %>% 
  mutate(swe_ft = (Snow_Water_Equivalent_in/12)) %>% 
  select(Date, year, month, day, temp = Daily_Ave_Temp_C, swe_ft) %>% 
  transform(temp = ave(temp, FUN = na.approx))
```


**3.** Read in snowpack melt model.
```{r}

source("../R/melt_submodel.R") 

```

**4.** Run melt_submodel with SNOTEL data.
```{r}

input_year = 2015

melt_df <- as.data.frame(melt(SWE = snotel_final_swe, input_year = input_year, mf = 0.0131234))
  

```


**5.** Perform sensitivity analysis on melt factor (mf).
```{r}

```

**6.** Graph results.
```{r}

melt_plot <- ggplot(data = melt_df) +
  geom_line(aes(x = date, y = flow))
  
melt_plot

```


**7.** Read in bathtub/watershed storage model.
```{r}

source("../R/bathtub_submodel.R")


```

**8.** Run bathtub_submodel with results from snowpack melt. ODE (if time allows) 
```{r}

bathtub_df <- as.data.frame(outflow(input_df = melt_df, storage_initial = 70555, k = 0.001, evap = 22.66))


```


**9.** Perform sensitivity analysis on K.
```{r}

```

**10.** Graph results.
```{r}

```

**11.** Read in temperature data.
```{r}
ambient <- read_csv(here::here("Data", "ambient_air_tempmodel.csv")) %>% 
  mutate(daily_max_temp_c = as.numeric(daily_max_temp_c)) %>% 
  transform(daily_max_temp_c = ave(daily_max_temp_c, FUN = na.approx))
  

water <- read_csv(here::here("Data", "water_temp_tempmodel.csv")) %>% 
  mutate(mean_water_temp_c = replace_na(mean_water_temp_c,0))


water_2015 <- water %>% 
  filter(year == 2015)

```

**12.** Read in temperature model.
```{r}
source("../R/temperature_submodel.R") 

```

**13.** Run temperature model with temperature data.
```{r}

water_temp <- as.data.frame(water_temp(ambient = ambient, water = water, bathtub_df = bathtub_df, input_year = input_year)) %>% 
  mutate(temp_w_change = temp_calc - temp_w)

```

**14.** Graph results.
```{r}

ggplot(data = water_temp)+
  geom_line(aes(x = date, y = temp_a), color = "orange")+
  geom_line(aes(x = date, y = temp_w_change), color = "blue")


# maybe would be nice to calculate some sort of running average to visualize overall trends?
```